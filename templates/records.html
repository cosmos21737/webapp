{% extends "base.html" %}

{% block title %}私の測定記録{% endblock %}

{% block content %}

{% if current_user.has_any_role('coach', 'director', "administer") %}
<form method="POST" action="{{ url_for('members.delete_member', member_id=user.user_id) }}"
      onsubmit="return confirm('本当に削除しますか？');">
    <button type="submit" class="delete-btn">部員を削除</button>
</form>
<form method="POST" action="{{ url_for('members.push_team', member_id=user.user_id) }}">
    <button type="submit">チームに登録</button>
</form>
<form method="POST" action="{{ url_for('members.delete_team', member_id=user.user_id) }}">
    <button type="submit">チームから削除</button>
</form>
{% endif %}

<h2>{{ user.name }} さんの測定記録</h2>
<div class="export_records_csv">
    <a href="{{ url_for('records.export_csv') }}">CSV出力</a>
</div>

<!-- 順位表示セクション -->
<div class="rankings-section">
    <h3>全体順位</h3>
    <div class="rankings-grid">
        {% for metric, data in rankings.items() %}
        <div class="ranking-card">
            <div class="metric-name">{{ metric }}</div>
            <div class="metric-value">{{ data.value }}</div>
            <div class="rank-info">
                <span class="rank">順位: {{ data.rank }}位</span>
                <span class="stddev">偏差値: {{ data.stddev }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- 折れ線グラフセクション -->
<div class="chart-section">
    <h3>記録の推移</h3>
    <div class="chart-container">
        <canvas id="recordsChart"></canvas>
    </div>
    <div class="chart-controls">
        <select id="metricSelector" class="form-control">
            <option value="run_50m">50m走 (秒)</option>
            <option value="base_running">ベースランニング (秒)</option>
            <option value="long_throw">遠投距離 (m)</option>
            <option value="straight_speed">ストレート球速 (km/h)</option>
            <option value="hit_speed">打球速度 (km/h)</option>
            <option value="swing_speed">スイング速度 (km/h)</option>
            <option value="bench_press">ベンチプレス (kg)</option>
            <option value="squat">スクワット (kg)</option>
        </select>
    </div>
</div>

<!-- 記録テーブル -->
<table class="member-table">
    <thead>
        <tr>
            <th>測定日</th>
            <th>50m走 (秒)</th>
            <th>ベースランニング (秒)</th>
            <th>遠投距離 (m)</th>
            <th>ストレート球速 (km/h)</th>
            <th>打球速度 (km/h)</th>
            <th>スイング速度 (km/h)</th>
            <th>ベンチプレス (kg)</th>
            <th>スクワット (kg)</th>
        </tr>
    </thead>
    <tbody>
        {% for record in records %}
        <tr>
            <td>{{ record.measurement_date }}</td>
            <td>{{ record.run_50m }}</td>
            <td>{{ record.base_running }}</td>
            <td>{{ record.long_throw }}</td>
            <td>{{ record.straight_speed }}</td>
            <td>{{ record.hit_speed }}</td>
            <td>{{ record.swing_speed }}</td>
            <td>{{ record.bench_press }}</td>
            <td>{{ record.squat }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ページネーション -->
<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('records.my_records', page=pagination.prev_num, sort_by=sort_by, sort_order=sort_order) }}">前へ</a>
    {% endif %}

    {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
            {% if page_num == pagination.page %}
                <strong>{{ page_num }}</strong>
            {% else %}
                <a href="{{ url_for('records.my_records', page=page_num, sort_by=sort_by, sort_order=sort_order) }}">{{ page_num }}</a>
            {% endif %}
        {% else %}
            <span class="ellipsis">…</span>
        {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
        <a href="{{ url_for('records.my_records', page=pagination.next_num, sort_by=sort_by, sort_order=sort_order) }}">次へ</a>
    {% endif %}
</div>


<!-- Chart.jsのCDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* 既存のスタイルはそのままに... */

    /* グラフセクションのスタイル */
    .chart-section {
        margin: 30px 0;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }

    .chart-controls {
        text-align: center;
    }

    .form-control {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 16px;
    }
</style>

<script>
    // 記録データをJavaScriptで利用できるように準備
    const recordsData = {
        dates: [{% for record in records %}"{{ record.measurement_date }}"{% if not loop.last %}, {% endif %}{% endfor %}],
        run_50m: [{% for record in records %}{{ record.run_50m or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        base_running: [{% for record in records %}{{ record.base_running or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        long_throw: [{% for record in records %}{{ record.long_throw or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        straight_speed: [{% for record in records %}{{ record.straight_speed or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        hit_speed: [{% for record in records %}{{ record.hit_speed or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        swing_speed: [{% for record in records %}{{ record.swing_speed or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        bench_press: [{% for record in records %}{{ record.bench_press or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}],
        squat: [{% for record in records %}{{ record.squat or 'null' }}{% if not loop.last %}, {% endif %}{% endfor %}]
    };

    // グラフの初期設定
    const ctx = document.getElementById('recordsChart').getContext('2d');
    let chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: recordsData.dates,
            datasets: [{
                label: '50m走 (秒)',
                data: recordsData.run_50m,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    // メトリクス選択時のグラフ更新
    document.getElementById('metricSelector').addEventListener('change', function() {
        const metric = this.value;
        const metricLabels = {
            'run_50m': '50m走 (秒)',
            'base_running': 'ベースランニング (秒)',
            'long_throw': '遠投距離 (m)',
            'straight_speed': 'ストレート球速 (km/h)',
            'hit_speed': '打球速度 (km/h)',
            'swing_speed': 'スイング速度 (km/h)',
            'bench_press': 'ベンチプレス (kg)',
            'squat': 'スクワット (kg)'
        };

        chart.data.datasets[0].label = metricLabels[metric];
        chart.data.datasets[0].data = recordsData[metric];
        chart.update();
    });
</script>

{% endblock %}