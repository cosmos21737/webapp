{% extends "base.html" %}

{% block title %}チーム一覧{% endblock %}

{% block content %}
<h2>チーム一覧</h2>

<!-- レーダーチャート用のコンテナを追加 -->
<div class="chart-container">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <canvas id="teamRadarChart" width="600" height="600"></canvas>
</div>

<script>
  const ctx = document.getElementById('teamRadarChart');

  const data = {
    labels: {{ team_stats.keys()|list|tojson }},
    datasets: [{
      label: 'チーム偏差値',
      data: {{ team_stats.values()|map(attribute='stddev')|list|tojson }},
      fill: true,
      backgroundColor: 'rgba(54, 162, 235, 0.2)',
      borderColor: 'rgba(54, 162, 235, 1)',
      pointBackgroundColor: 'rgba(54, 162, 235, 1)',
      pointRadius: 6,
      pointHoverRadius: 8
    }]
  };

  new Chart(ctx, {
    type: 'radar',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          suggestedMin: 30,
          suggestedMax: 70,
          ticks: {
            font: {
              size: 14
            }
          },
          pointLabels: {
            font: {
              size: 16,
              weight: 'bold'
            }
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'チーム偏差値レーダーチャート',
          font: {
            size: 20,
            weight: 'bold'
          },
          padding: 20
        },
        legend: {
          labels: {
            font: {
              size: 16
            }
          }
        }
      }
    }
  });
</script>

<div class="table-container">
    <table id="teamMemberTable" class="member-table display">
      <thead>
        <tr>
          <th>氏名</th>
          <th>学年</th>
          {% for m_type in measurement_types %}
            <th>{{ m_type.display_name }}<br><span style="font-size:0.8em;">(偏差値)</span></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for member in team %}
        <tr>
          <td><a href="{{ url_for('members.member_records', member_id=member.user_id) }}">{{ member.name }}</a></td>
          <td>{{ member.grade }}</td>
          {% for m_type in measurement_types %}
            <td>
              {% set stddev = member_stddevs[member.user_id][m_type.display_name]['stddev'] %}
              {{ stddev if stddev != 'N/A' else '-' }}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
</div>


<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> {# jQueryの読み込みを忘れずに #}
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DataTablesの初期化
    $('#teamMemberTable').DataTable({
        "pageLength": 10, // 1ページあたりの表示件数
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Japanese.json"
        },
        "order": [[1, 'asc']], // 学年（1列目）をデフォルトで昇順ソート
        "scrollX": true,            // 横スクロール
        "scrollY": "400px",         // 縦スクロール（高さ指定）
        "scrollCollapse": true,     // スクロールバーの自動表示/非表示
        "autoWidth": true,          // 自動幅調整
        "fixedHeader": true,        // ヘッダー固定
        "fixedColumns": {           // 列固定
            "left": 2,              // 左2列を固定
            "right": 1              // 右1列を固定
        },
        "columnDefs": [
            { "width": "20%", "targets": 0 },  // 1列目を20%幅
            { "className": "text-center", "targets": "_all" } // 3列目を中央揃え
        ]
    });
});
</script>

<style>
    /* チャートコンテナのスタイル */
    .chart-container {
        width: 100%;
        max-width: 800px;
        height: 600px;
        margin: 20px auto;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    /* テーブルコンテナのスタイル */
    .table-container {
        width: 100%;
        overflow-x: auto;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* テーブルの基本スタイル */
    #teamMemberTable {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
    }

    #teamMemberTable th,
    #teamMemberTable td {
        padding: 8px 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
        white-space: nowrap; /* テキストの折り返しを防ぐ */
    }

    #teamMemberTable th {
        background-color: #f8f9fa;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #teamMemberTable tbody tr:hover {
        background-color: #f5f5f5;
    }

    #teamMemberTable a {
        color: #007bff;
        text-decoration: none;
    }

    #teamMemberTable a:hover {
        text-decoration: underline;
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
        .chart-container {
            max-width: 100%;
            height: 400px;
            padding: 10px;
        }
        
        .table-container {
            font-size: 14px;
        }
        
        #teamMemberTable th,
        #teamMemberTable td {
            padding: 6px 8px;
        }
    }
</style>

{% endblock %}