{% extends "base.html" %}

{% block title %}チーム一覧{% endblock %}

{% block content %}
<h2>チーム一覧</h2>

<nav>
    <ul>
        <li><a href="{{ url_for('members.new_member') }}" style="color: black;">新しい部員を登録</a></li>
        <li><a href="{{ url_for('members.export_csv') }}" style="color: black;">CSV出力</a></li>
    </ul>
</nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<canvas id="teamRadarChart" width="400" height="400"></canvas>
<script>
  const ctx = document.getElementById('teamRadarChart');

  const data = {
    labels: {{ team_stats.keys()|list|tojson }},
    datasets: [{
      label: 'チーム偏差値',
      data: {{ team_stats.values()|map(attribute='stddev')|list|tojson }},
      fill: true,
      backgroundColor: 'rgba(54, 162, 235, 0.2)',
      borderColor: 'rgba(54, 162, 235, 1)',
      pointBackgroundColor: 'rgba(54, 162, 235, 1)'
    }]
  };

  new Chart(ctx, {
    type: 'radar',
    data: data,
    options: {
      scales: {
        r: {
          suggestedMin: 30,
          suggestedMax: 70
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'チーム偏差値レーダーチャート'
        }
      }
    }
  });
</script>

<table id="teamMemberTable" class="member-table display">
  <thead>
    <tr>
      <th>氏名</th>
      <th>学年</th>
      {% for m_type in measurement_types %}
        <th>{{ m_type.display_name }}<br><span style="font-size:0.8em;">(偏差値)</span></th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for member in team %}
    <tr>
      <td><a href="{{ url_for('members.member_records', member_id=member.user_id) }}">{{ member.name }}</a></td>
      <td>{{ member.grade }}</td>
      {% for m_type in measurement_types %}
        <td>
          {% set stddev = member_stddevs[member.user_id][m_type.display_name]['stddev'] %}
          {{ stddev if stddev != 'N/A' else '-' }}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

{# ページネーションのHTMLブロックはDataTablesが自動生成するため削除 #}
{# <div class="pagination">...</div> #}

{# ソートヘルプテキストもDataTablesのUIで提供されるため削除 #}
{# <div class="sort-help">...</div> #}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> {# jQueryの読み込みを忘れずに #}
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DataTablesの初期化
    $('#teamMemberTable').DataTable({
        "pageLength": 10, // 1ページあたりの表示件数
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Japanese.json"
        },
        "order": [[1, 'asc']] // 学年（1列目）をデフォルトで昇順ソート
    });
});
</script>

{% endblock %}